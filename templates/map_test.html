<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kakao Map Test</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{js_key}}"></script>
</head>
<body>
    <h1>Kakao Map Test Page</h1>

    <h3>지도 바로가기</h3>
    <button onclick="getMapLink()">지도 보기</button>

    <h3>길찾기 바로가기</h3>
    <button onclick="getRouteLink()">길찾기 보기</button>

    <h3>로드뷰 바로가기</h3>
    <button onclick="getRoadviewLink()">로드뷰 보기</button>

    <h3>Kakao Geocoding testing</h3>
    <button onclick="addMarkerByAddress('대구 남구 중앙대로 225')">테스트 보기</button> <button onclick="showUserLocation()">내 위치 보기</button>
{#    TODO : get parameter from DB#}
    <div id="map" style="width:500px;height:400px;"></div>
    <h3>지오코딩 결과</h3>
    <p id="geocodeResult">위도: <span id="latitudeResult"></span>, 경도: <span id="longitudeResult"></span></p>

    <script>
        var mapContainer = document.getElementById('map');
        var mapOption = {
            center: new kakao.maps.LatLng(37.50802, 127.062835),
            level: 3
        };
        var map = new kakao.maps.Map(mapContainer, mapOption);

        function getMapLink() {
            fetch('/api/map_link/?latitude=37.402056&longitude=127.108212&name=우리회사')
            .then(response => response.json())
            .then(data => {
                window.location.href = data.link;
            });
        }

        function getRouteLink() {
            fetch('/api/route_link/?latitude=37.402056&longitude=127.108212&name=카카오판교오피스')
            .then(response => response.json())
            .then(data => {
                window.location.href = data.link;
            });
        }

        function getRoadviewLink() {
            fetch('/api/roadview_link/?latitude=37.402056&longitude=127.108212')
            .then(response => response.json())
            .then(data => {
                window.location.href = data.link;
            });
        }

        function addMarkerByAddress(address) {
            fetch(`/api/geocode/?address=${address}`)
            .then(response => response.json())
            .then(data => {
                if (data.latitude && data.longitude) {
                    document.getElementById("latitudeResult").innerText = data.latitude;
                    document.getElementById("longitudeResult").innerText = data.longitude;

                    const position = new kakao.maps.LatLng(data.latitude, data.longitude);
                    const marker = new kakao.maps.Marker({
                        position: position
                    });
                    marker.setMap(map);
                } else {
                    alert("주소를 변환할 수 없습니다.");
                }
            });
        }
        var userMarker;
        function showUserLocation() {
    // 브라우저 지원 여부 확인
    if (!navigator.geolocation) {
        alert("이 브라우저에서는 Geolocation이 지원되지 않습니다.");
        return;
    }

    function success(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const userPosition = new kakao.maps.LatLng(latitude, longitude);

        // 만약 userMarker가 이미 존재한다면 위치만 업데이트
        if (userMarker) {
            userMarker.setPosition(userPosition);
        } else {
            userMarker = new kakao.maps.Marker({
                position: userPosition,
                image: new kakao.maps.MarkerImage(
                    'https://icons.iconarchive.com/icons/emey87/trainee/16/Gps-icon.png',
                    new kakao.maps.Size(24, 24),
                    { offset: new kakao.maps.Point(12, 12) }
                ),
                draggable: true  // 마커를 드래그 가능하게 설정
            });
            userMarker.setMap(map);
        }

        // 지도 중심을 사용자 위치로 이동
        map.setCenter(userPosition);
    }

    function error() {
        alert("위치 정보를 가져올 수 없습니다.");
    }
    navigator.geolocation.getCurrentPosition(success, error);
}
</script>


</body>
</html>
